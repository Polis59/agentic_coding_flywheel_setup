#!/usr/bin/expect -f
# ============================================================
# Navigation E2E Test - Expect Script
# Tests back navigation, edit mode, and screen transitions
#
# Usage: expect navigation.exp <newproj_script> <test_type>
# test_type: back_navigation | edit_from_confirm | escape_cancel
# ============================================================

set timeout 30
log_user 1

# Arguments
if {[llength $argv] < 2} {
    puts stderr "Usage: navigation.exp <newproj_script> <test_type>"
    exit 1
}

set newproj_script [lindex $argv 0]
set test_type [lindex $argv 1]

# Helpers
proc send_key {key} {
    send $key
    sleep 0.1
}

proc send_enter {} {
    send_key "\r"
}

proc send_escape {} {
    send_key "\033"
}

proc send_back {} {
    send_key "b"
}

proc type_text {text} {
    send $text
    sleep 0.05
}

proc log_step {msg} {
    puts stderr "\[NAV\] $msg"
}

# Start the wizard
log_step "Starting wizard for test: $test_type"
spawn bash $newproj_script --interactive

# Wait for welcome
expect {
    timeout { puts stderr "ERROR: Timeout at Welcome"; exit 1 }
    "Welcome to ACFS" { log_step "At Welcome screen" }
}

# ============================================================
# Test: Back Navigation
# ============================================================
if {$test_type eq "back_navigation"} {
    log_step "Testing back navigation..."

    # Go forward through screens
    send_enter  ;# Welcome -> Project Name
    expect "Project Name"

    type_text "nav-test"
    send_enter  ;# Project Name -> Directory
    expect "Project Directory"

    send_enter  ;# Directory -> Tech Stack
    expect "Technology Stack"

    # Now go back
    log_step "Going back from Tech Stack"
    send_back
    expect {
        timeout { puts stderr "ERROR: Back navigation failed"; exit 1 }
        "Project Directory" { log_step "Successfully went back to Directory" }
    }

    # Go back again
    log_step "Going back from Directory"
    send_back
    expect {
        timeout { puts stderr "ERROR: Back navigation failed"; exit 1 }
        "Project Name" { log_step "Successfully went back to Project Name" }
    }

    # Verify we can't go back from first screen
    log_step "Trying to go back from Project Name (should not go to Welcome)"
    send_back

    # Should still be on Project Name (can't go back past first input screen)
    sleep 0.3

    # Cancel and exit
    send_escape
    expect eof

    log_step "Back navigation test completed successfully"
    exit 0
}

# ============================================================
# Test: Edit from Confirmation
# ============================================================
if {$test_type eq "edit_from_confirm"} {
    log_step "Testing edit mode from confirmation..."

    # Navigate to confirmation screen
    send_enter  ;# Welcome
    expect "Project Name"

    type_text "edit-test"
    send_enter
    expect "Project Directory"

    send_enter  ;# Use default directory
    expect "Technology Stack"

    send_enter  ;# Skip tech
    expect "Features"

    send_enter  ;# Accept features
    expect "AGENTS.md Preview"

    send_enter  ;# Continue from preview
    expect "Review & Confirm"

    log_step "At Confirmation screen, pressing 'e' to edit"
    send_key "e"

    # Should go back to Project Name
    expect {
        timeout { puts stderr "ERROR: Edit mode didn't go to Project Name"; exit 1 }
        "Project Name" { log_step "Successfully returned to Project Name for editing" }
    }

    # Verify we can change the name
    type_text "edited-project"
    send_enter

    expect "Project Directory"
    log_step "Edit mode working correctly"

    # Cancel
    send_escape
    expect eof

    log_step "Edit from confirmation test completed successfully"
    exit 0
}

# ============================================================
# Test: Escape Cancel
# ============================================================
if {$test_type eq "escape_cancel"} {
    log_step "Testing escape to cancel..."

    # Go to a few screens
    send_enter  ;# Welcome
    expect "Project Name"

    type_text "cancel-test"
    send_enter
    expect "Project Directory"

    # Press Escape to cancel
    log_step "Pressing Escape to cancel"
    send_escape

    # Wait for clean exit
    expect {
        timeout { puts stderr "ERROR: Escape didn't exit wizard"; exit 1 }
        eof { log_step "Wizard exited cleanly on Escape" }
    }

    log_step "Escape cancel test completed successfully"
    exit 0
}

# Unknown test type
puts stderr "ERROR: Unknown test type: $test_type"
exit 1
