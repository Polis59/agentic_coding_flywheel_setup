#!/usr/bin/expect -f
# ============================================================
# Happy Path E2E Test - Expect Script
# Runs through the wizard with all defaults
#
# Usage: expect happy_path.exp <newproj_script> <project_name> <project_dir>
# ============================================================

# Configuration
set timeout 30
log_user 1

# Arguments
if {[llength $argv] < 3} {
    puts stderr "Usage: happy_path.exp <newproj_script> <project_name> <project_dir>"
    exit 1
}

set newproj_script [lindex $argv 0]
set project_name [lindex $argv 1]
set project_dir [lindex $argv 2]

# Helper to send key with small delay
proc send_key {key} {
    send $key
    sleep 0.1
}

proc send_enter {} {
    send_key "\r"
}

proc send_escape {} {
    send_key "\033"
}

proc type_text {text} {
    send $text
    sleep 0.05
}

# Log function
proc log_step {msg} {
    puts stderr "\[E2E\] $msg"
}

# Start the wizard
log_step "Starting wizard: $newproj_script --interactive"
spawn bash $newproj_script --interactive

# ============================================================
# Screen 1: Welcome
# ============================================================
log_step "Waiting for Welcome screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Welcome screen"; exit 1 }
    "Welcome to ACFS" { log_step "Welcome screen detected" }
}

# Press Enter to continue
log_step "Pressing Enter to continue from Welcome"
send_enter

# ============================================================
# Screen 2: Project Name
# ============================================================
log_step "Waiting for Project Name screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Project Name screen"; exit 1 }
    "Project Name" { log_step "Project Name screen detected" }
}

# Type project name and press Enter
log_step "Typing project name: $project_name"
type_text $project_name
send_enter

# ============================================================
# Screen 3: Directory
# ============================================================
log_step "Waiting for Directory screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Directory screen"; exit 1 }
    "Project Directory" { log_step "Directory screen detected" }
}

# Clear default and type custom directory
log_step "Typing directory: $project_dir"
# Clear any pre-filled content
send "\025"  ;# Ctrl+U to clear line
type_text $project_dir
send_enter

# ============================================================
# Screen 4: Tech Stack
# ============================================================
log_step "Waiting for Tech Stack screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Tech Stack screen"; exit 1 }
    "Technology Stack" { log_step "Tech Stack screen detected" }
}

# Press Enter to skip tech selection (use defaults)
log_step "Pressing Enter to skip tech selection"
send_enter

# ============================================================
# Screen 5: Features
# ============================================================
log_step "Waiting for Features screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Features screen"; exit 1 }
    "Features" { log_step "Features screen detected" }
}

# Press Enter to accept default features
log_step "Pressing Enter to accept default features"
send_enter

# ============================================================
# Screen 6: AGENTS.md Preview
# ============================================================
log_step "Waiting for AGENTS.md Preview screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for AGENTS Preview screen"; exit 1 }
    "AGENTS.md Preview" { log_step "AGENTS Preview screen detected" }
}

# Press Enter to continue
log_step "Pressing Enter to continue from AGENTS preview"
send_enter

# ============================================================
# Screen 7: Confirmation
# ============================================================
log_step "Waiting for Confirmation screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Confirmation screen"; exit 1 }
    "Review & Confirm" { log_step "Confirmation screen detected" }
}

# Press 'c' to create project
log_step "Pressing 'c' to create project"
send_key "c"

# ============================================================
# Screen 8: Progress
# ============================================================
log_step "Waiting for Progress screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Progress screen"; exit 1 }
    "Creating Project" { log_step "Progress screen detected" }
}

# Wait for completion
log_step "Waiting for project creation to complete..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for project creation"; exit 1 }
    "Project Created" { log_step "Project created successfully!" }
}

# ============================================================
# Screen 9: Success
# ============================================================
log_step "Waiting for Success screen..."
expect {
    timeout { puts stderr "ERROR: Timeout waiting for Success screen"; exit 1 }
    "Project Created" { log_step "Success screen detected" }
}

# Press 'q' to quit
log_step "Pressing 'q' to quit"
send_key "q"

# Wait for clean exit
expect eof

# Get exit code
catch wait result
set exit_code [lindex $result 3]

log_step "Wizard completed with exit code: $exit_code"

# Verify project was created
if {[file exists $project_dir]} {
    log_step "SUCCESS: Project directory created at $project_dir"
    exit 0
} else {
    puts stderr "ERROR: Project directory not found: $project_dir"
    exit 1
}
