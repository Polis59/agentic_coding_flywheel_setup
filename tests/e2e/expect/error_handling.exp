#!/usr/bin/expect -f
# ============================================================
# Error Handling E2E Test - Expect Script
# Tests validation errors, directory conflicts, etc.
#
# Usage: expect error_handling.exp <newproj_script> <test_type> [args...]
# test_type: invalid_name | existing_dir | validation_recovery
# ============================================================

set timeout 30
log_user 1

if {[llength $argv] < 2} {
    puts stderr "Usage: error_handling.exp <newproj_script> <test_type> \[args...\]"
    exit 1
}

set newproj_script [lindex $argv 0]
set test_type [lindex $argv 1]

# Helpers
proc send_key {key} {
    send $key
    sleep 0.1
}

proc send_enter {} {
    send_key "\r"
}

proc send_escape {} {
    send_key "\033"
}

proc clear_line {} {
    send "\025"  ;# Ctrl+U
}

proc type_text {text} {
    send $text
    sleep 0.05
}

proc log_step {msg} {
    puts stderr "\[ERR\] $msg"
}

# Start wizard
log_step "Starting wizard for error test: $test_type"
spawn bash $newproj_script --interactive

expect {
    timeout { puts stderr "ERROR: Timeout at Welcome"; exit 1 }
    "Welcome to ACFS" { log_step "At Welcome screen" }
}

# ============================================================
# Test: Invalid Project Name
# ============================================================
if {$test_type eq "invalid_name"} {
    log_step "Testing invalid project name handling..."

    send_enter  ;# Welcome -> Project Name
    expect "Project Name"

    # Try empty name
    log_step "Trying empty name"
    send_enter
    sleep 0.3

    # Should show error or stay on same screen
    expect {
        "Project Name" { log_step "Correctly rejected empty name" }
        timeout { puts stderr "WARN: No clear rejection of empty name"; }
    }

    # Try name with spaces
    log_step "Trying name with spaces"
    type_text "bad name"
    send_enter
    sleep 0.3

    expect {
        "Project Name" { log_step "Correctly rejected name with spaces" }
        "Project Directory" { log_step "Name with spaces was accepted (may be valid)" }
        timeout {}
    }

    # Use valid name to continue
    clear_line
    type_text "valid-name"
    send_enter

    expect "Project Directory"
    log_step "Successfully entered valid name"

    send_escape
    expect eof
    exit 0
}

# ============================================================
# Test: Existing Directory
# ============================================================
if {$test_type eq "existing_dir"} {
    if {[llength $argv] < 3} {
        puts stderr "ERROR: existing_dir test requires directory path"
        exit 1
    }

    set existing_dir [lindex $argv 2]
    log_step "Testing existing directory: $existing_dir"

    send_enter  ;# Welcome
    expect "Project Name"

    type_text "conflict-test"
    send_enter
    expect "Project Directory"

    # Enter existing directory
    clear_line
    type_text $existing_dir
    send_enter

    # Should show error about existing directory
    sleep 0.5
    expect {
        -re "(exists|already|conflict|Error)" {
            log_step "Correctly detected existing directory conflict"
        }
        "Technology Stack" {
            log_step "WARN: Existing directory accepted (might be overwrite mode)"
        }
        timeout {
            log_step "No clear error message, but stayed on screen"
        }
    }

    send_escape
    expect eof
    exit 0
}

# ============================================================
# Test: Validation Recovery
# ============================================================
if {$test_type eq "validation_recovery"} {
    log_step "Testing recovery from validation errors..."

    send_enter  ;# Welcome
    expect "Project Name"

    # Enter bad name, get error, then fix it
    log_step "Entering invalid name then recovering"
    send_enter  ;# Empty = invalid

    sleep 0.3

    # Now enter valid name
    type_text "recovery-test"
    send_enter

    expect {
        "Project Directory" {
            log_step "Successfully recovered from validation error"
        }
        timeout {
            puts stderr "ERROR: Could not recover from validation"
            exit 1
        }
    }

    # Continue through wizard to verify state is clean
    send_enter  ;# Accept default directory
    expect "Technology Stack"

    log_step "Validation recovery test passed"

    send_escape
    expect eof
    exit 0
}

puts stderr "ERROR: Unknown test type: $test_type"
exit 1
