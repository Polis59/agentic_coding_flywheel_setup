name: Monitor Upstream Checksums

on:
  schedule:
    - cron: "0 6 * * *"   # 6 AM UTC daily
    - cron: "0 18 * * *"  # 6 PM UTC daily (stability check)
  workflow_dispatch:       # Manual trigger for testing

jobs:
  check-checksums:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore checksum cache
        uses: actions/cache@v4
        with:
          path: .checksum-cache
          key: checksum-monitor-${{ github.run_id }}
          restore-keys: |
            checksum-monitor-

      - name: Verify current checksums
        id: verify
        run: |
          chmod +x ./scripts/lib/security.sh
          ./scripts/lib/security.sh --verify --json > current.json

          # Extract counts from JSON
          mismatches=$(jq '.mismatches | length' current.json)
          errors=$(jq '.errors | length' current.json)
          total_issues=$((mismatches + errors))

          echo "mismatches=$mismatches" >> $GITHUB_OUTPUT
          echo "errors=$errors" >> $GITHUB_OUTPUT
          echo "total_issues=$total_issues" >> $GITHUB_OUTPUT

          if [[ "$total_issues" -gt 0 ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            jq -r '.mismatches[].name' current.json > changed_tools.txt 2>/dev/null || true
            jq -r '.errors[].name' current.json >> changed_tools.txt 2>/dev/null || true
            echo "Changed/errored tools:"
            cat changed_tools.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "All checksums match!"
          fi

      - name: Check stability
        if: steps.verify.outputs.changed == 'true'
        id: stability
        run: |
          # Get current mismatches as sorted list
          current_issues=$(jq -r '[.mismatches[].name, .errors[].name] | sort | join(",")' current.json)

          if [[ -f ".checksum-cache/previous_issues.txt" ]]; then
            previous_issues=$(cat .checksum-cache/previous_issues.txt)

            if [[ "$current_issues" == "$previous_issues" ]]; then
              echo "stable=true" >> $GITHUB_OUTPUT
              echo "Checksums stable across 2 runs - safe to create PR"
            else
              echo "stable=false" >> $GITHUB_OUTPUT
              echo "Issues changed since last run - waiting for stability"
              echo "Previous: $previous_issues"
              echo "Current: $current_issues"
            fi
          else
            echo "stable=false" >> $GITHUB_OUTPUT
            echo "First run with changes - caching for stability check"
          fi

          # Update cache
          mkdir -p .checksum-cache
          echo "$current_issues" > .checksum-cache/previous_issues.txt
          cp current.json .checksum-cache/previous.json

      - name: Generate updated checksums
        if: steps.verify.outputs.changed == 'true' && steps.stability.outputs.stable == 'true'
        run: |
          ./scripts/lib/security.sh --update-checksums > checksums.yaml.new
          mv checksums.yaml.new checksums.yaml

      - name: Create Pull Request
        if: steps.verify.outputs.changed == 'true' && steps.stability.outputs.stable == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore(security): update upstream checksums"
          body: |
            ## Upstream Checksum Updates

            The following installer checksums have changed:

            ```
            ${{ steps.verify.outputs.mismatches }} mismatches
            ${{ steps.verify.outputs.errors }} errors
            ```

            **Changed tools:**
            $(cat changed_tools.txt | sed 's/^/- /' || echo "- See verification output")

            ### Stability Verified

            Checksums have been stable across 2 consecutive checks (12 hours apart).

            ### Action Required

            Please review the upstream changes before merging. The changes may be due to:
            - Normal upstream updates (most common)
            - Security patches
            - Potential supply chain issues (rare, but verify)

            ---
            Generated by checksum monitoring workflow
          branch: auto/update-checksums
          labels: security, automated
          delete-branch: true

      - name: Summary
        run: |
          echo "## Checksum Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mismatches | ${{ steps.verify.outputs.mismatches }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.verify.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changed | ${{ steps.verify.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.verify.outputs.changed }}" == "true" ]]; then
            echo "| Stable | ${{ steps.stability.outputs.stable || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          fi
